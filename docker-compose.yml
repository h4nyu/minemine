version: '2.4'

x-app: &app
    image: "${DOCKER_REGISTRY:-localhost}/mine/mine"
    build:
      context: .
    shm_size: '30gb'


services:
  eth:
    <<: *app
    runtime: nvidia
    environment:
      - WORKER
      - ETH_POOL
      - ETH_USER
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES}
    command: miner  --algo ethash --ssl 1 --server $ETH_POOL --user $ETH_USER.$WORKER

  etc:
    <<: *app
    runtime: nvidia
    environment:
      - WORKER
      - ETC_POOL
      - ETC_USER
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES}
    command: miner  --algo etchash --ssl 1 --server $ETC_POOL --user $ETC_USER.$WORKER

  rvn:
    <<: *app
    runtime: nvidia
    environment:
      - WORKER
      - RVN_POOL
      - RVN_USER
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES}
    command: miner --algo kawpow --server $RVN_POOL --user $RVN_USER.$WORKER 

  ergo:
    <<: *app
    runtime: nvidia
    environment:
      - WORKER
      - ERGO_POOL
      - ERGO_USER
      - NVIDIA_VISIBLE_DEVICES=${NVIDIA_VISIBLE_DEVICES}
    command: lolMiner --algo AUTOLYKOS2 --pool $ERGO_POOL --user $ERGO_USER.$WORKER 

  chia:
    <<: *app
    entrypoint: ./chia_entrypoint.sh
    working_dir: /chia-blockchain
    volumes:
      - ./chia_entrypoint.sh:/chia-blockchain/chia_entrypoint.sh
      - ./mkplots.sh:/chia-blockchain/mkplots.sh
      - ./farmer.sh:/chia-blockchain/farmer.sh
      - $CHIA_MAINNET:/root/.chia/mainnet
      - $MNT:/mnt
    command: ./farmer.sh
    ports:
      - 8444:8444
    environment:
      - WORKER
      - CHIA_KEY
      - CHIA_POOL_CONTRACT_ADDRESS
      - TMP_PLOTS=${TMP_PLOTS:?}
